import{u as K,r as t,g as o,j as e,C as y,e as N,B as m,R as Q,a as z,b as H,d as X,a0 as Z,I as ee,L as se,$ as ae,l as te,a1 as re,a3 as ne}from"./index-DLzrVyEL.js";import{L as u}from"./label-N6WvVUTh.js";import{S as le}from"./switch-CtqUxp-4.js";import{T as ce}from"./textarea-Cg5T9mcn.js";import{S as v,a as w,b as k,c as S,d as C}from"./select-Bf3NEO-Y.js";import{S as x}from"./skeleton-C3jo3W2d.js";import{H as P}from"./HelpTip-Bf0ngYP4.js";import{u as ie}from"./usePageTitle-BWQ1x_eW.js";import{C as B}from"./circle-alert-ChFoNBvB.js";import{P as de}from"./play-qUrT09cP.js";import{T as oe}from"./trash-2-hOfGscB6.js";import"./index-C-bnBz93.js";import"./index-BmrRr2YK.js";import"./check-BnfHjeKt.js";function Ce(){ie("Automation");const g=K(s=>s.gatewayConnected),[p,b]=t.useState([]),[j,f]=t.useState(!0),[A,r]=t.useState(null),[T,$]=t.useState(""),[h,E]=t.useState(""),[l,V]=t.useState("0"),[c,I]=t.useState("9"),[i,O]=t.useState("*"),[M,D]=t.useState(!1),L=`${l} ${c} * * ${i}`,F=(()=>{const s=l==="*"?"":`:${l.padStart(2,"0")}`,a=c==="*"?"every hour":`${Number(c)%12||12}:${l==="*"?"xx":l.padStart(2,"0")} ${Number(c)>=12?"PM":"AM"}`,d=i==="*"?"every day":i==="1-5"?"weekdays":i==="0,6"?"weekends":i==="1"?"Mondays":`day ${i}`;return c==="*"&&l==="*"?`Every minute, ${d}`:c==="*"?`Every hour at ${s}, ${d}`:`${a}, ${d}`})(),n=t.useCallback(async()=>{if(!g){f(!1);return}f(!0),r(null);try{const s=await o.requestAsync("cron.list",{includeDisabled:!0});b((s==null?void 0:s.jobs)??[])}catch(s){r(String(s instanceof Error?s.message:s)),b([])}finally{f(!1)}},[g]);t.useEffect(()=>{n()},[n]);const U=async()=>{const s=T.trim()||`Job ${p.length+1}`;D(!0),r(null);try{await o.requestAsync("cron.add",{name:s,schedule:{kind:"cron",expr:L},sessionTarget:"main",wakeMode:"now",payload:{kind:"agentTurn",message:h.trim()||`Scheduled task: ${s}`},enabled:!0}),$(""),E(""),await n()}catch(a){r(String(a instanceof Error?a.message:a))}finally{D(!1)}},Y=async s=>{try{await o.requestAsync("cron.remove",{id:s.id}),await n(),re(`Deleted "${s.name}"`,async()=>{try{await o.requestAsync("cron.add",{name:s.name,schedule:s.schedule,sessionTarget:s.sessionTarget??"main",wakeMode:s.wakeMode??"now",payload:s.payload,enabled:s.enabled}),await n()}catch{ne("Failed to restore task","error")}})}catch(a){r(String(a instanceof Error?a.message:a))}},_=async s=>{try{await o.requestAsync("cron.update",{id:s.id,patch:{enabled:!s.enabled}}),await n()}catch(a){r(String(a instanceof Error?a.message:a))}},G=async s=>{try{await o.requestAsync("cron.run",{id:s.id,mode:"force"}),setTimeout(n,2e3)}catch(a){r(String(a instanceof Error?a.message:a))}},R=s=>s?new Date(s).toLocaleString():null;return g?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-2",children:["Automation",e.jsx(P,{text:"Schedule your agent to do things automatically — like sending daily summaries or checking for updates. Tasks run in the background, even when this app is closed."})]}),e.jsx("p",{className:"text-muted-foreground",children:"Schedule recurring agent tasks"})]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:n,disabled:j,"aria-label":"Refresh jobs",children:[e.jsx(Q,{className:`mr-2 h-4 w-4 ${j?"animate-spin":""}`}),"Refresh"]})]}),A&&e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-destructive/30 bg-destructive/5 p-3 text-sm text-destructive",children:[e.jsx(B,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:A}),e.jsx(m,{variant:"ghost",size:"sm",className:"ml-auto",onClick:()=>r(null),children:"Dismiss"})]}),e.jsxs(y,{children:[e.jsxs(z,{children:[e.jsx(H,{className:"text-lg",children:"New Scheduled Task"}),e.jsx(X,{children:"Create a task that runs on a schedule. Your agent executes it automatically."})]}),e.jsxs(N,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Task Name"}),e.jsx(Z,{placeholder:"e.g. Daily Summary",value:T,onChange:s=>$(s.target.value),maxLength:60})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Agent Message"}),e.jsx(ce,{placeholder:"What should the agent do when this task runs? e.g. 'Summarize today's activity and send it to Telegram'",value:h,onChange:s=>E(s.target.value.slice(0,2e3)),className:"min-h-[80px]"}),h.length>1800&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[h.length,"/2000"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Minute"}),e.jsxs(v,{value:l,onValueChange:V,children:[e.jsx(w,{children:e.jsx(k,{})}),e.jsx(S,{children:["0","15","30","45","*"].map(s=>e.jsx(C,{value:s,children:s==="*"?"Every minute":`:${s.padStart(2,"0")}`},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Hour"}),e.jsxs(v,{value:c,onValueChange:I,children:[e.jsx(w,{children:e.jsx(k,{})}),e.jsx(S,{children:Array.from({length:24},(s,a)=>String(a)).concat("*").map(s=>e.jsx(C,{value:s,children:s==="*"?"Every hour":`${s}:00`},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Day of Week"}),e.jsxs(v,{value:i,onValueChange:O,children:[e.jsx(w,{children:e.jsx(k,{})}),e.jsx(S,{children:[{v:"*",l:"Every day"},{v:"1-5",l:"Weekdays"},{v:"0,6",l:"Weekends"},{v:"1",l:"Monday"}].map(s=>e.jsx(C,{value:s.v,children:s.l},s.v))})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 rounded-lg bg-muted p-3",children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:F}),e.jsx("code",{className:"text-xs text-muted-foreground font-mono",children:L})]})]}),e.jsxs(m,{onClick:U,disabled:M,children:[M?e.jsx(se,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ae,{className:"mr-2 h-4 w-4"}),"Add Task"]})]})]}),e.jsxs(y,{children:[e.jsx(z,{children:e.jsx(H,{className:"text-lg",children:"Scheduled Tasks"})}),e.jsx(N,{children:j?e.jsx("div",{className:"space-y-3",children:[1,2].map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{className:"h-5 w-9 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"h-4 w-32"}),e.jsx(x,{className:"h-3 w-48"})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(x,{className:"h-8 w-8 rounded-md"}),e.jsx(x,{className:"h-8 w-8 rounded-md"})]})]},s))}):p.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No scheduled tasks. Create one above."}):e.jsx("div",{className:"space-y-3",children:p.map(s=>{var a,d,J,q,W;return e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(le,{checked:s.enabled,onCheckedChange:()=>_(s)}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium",children:s.name}),((a=s.state)==null?void 0:a.lastStatus)&&e.jsx(te,{variant:s.state.lastStatus==="ok"?"success":"destructive",children:s.state.lastStatus})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("code",{children:s.schedule.expr??s.schedule.kind}),((d=s.state)==null?void 0:d.nextRunAtMs)&&e.jsxs("span",{children:["Next: ",R(s.state.nextRunAtMs)]}),((J=s.state)==null?void 0:J.lastRunAtMs)&&e.jsxs("span",{children:["Last: ",R(s.state.lastRunAtMs)]})]}),((q=s.payload)==null?void 0:q.message)&&e.jsx("p",{className:"text-xs text-muted-foreground/70 truncate max-w-[400px]",children:s.payload.message}),((W=s.state)==null?void 0:W.lastError)&&e.jsx("p",{className:"text-xs text-destructive truncate max-w-[400px]",children:s.state.lastError})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(m,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>G(s),"aria-label":"Run now",title:"Run now",children:e.jsx(de,{className:"h-4 w-4"})}),e.jsx(m,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>Y(s),"aria-label":"Delete task",children:e.jsx(oe,{className:"h-4 w-4"})})]})]},s.id)})})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-2",children:["Automation",e.jsx(P,{text:"Schedule your agent to do things automatically — like sending daily summaries or checking for updates. Tasks run in the background, even when this app is closed."})]}),e.jsx("p",{className:"text-muted-foreground",children:"Schedule recurring agent tasks"})]}),e.jsx(y,{children:e.jsxs(N,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(B,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground font-medium",children:"Agents must be running"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Start your agents from the Dashboard to manage scheduled tasks."})]})})]})}export{Ce as default};
