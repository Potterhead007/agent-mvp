import{c as p,r,i as y,j as e,C as d,e as m,B as h,R as K,Y as ie,a as j,b as N,O as ce,M as oe,a0 as V,L as P,l as de,a3 as u}from"./index-DLzrVyEL.js";import{S as v}from"./skeleton-C3jo3W2d.js";import{H as me}from"./HelpTip-Bf0ngYP4.js";import{u as ue}from"./usePageTitle-BWQ1x_eW.js";import{C as O}from"./check-BnfHjeKt.js";/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=p("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=p("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=p("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=p("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=p("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]),Y=["telegram","slack","discord"];function be(){ue("Usage");const[n,G]=r.useState([]),[C,k]=r.useState(!0),[S,D]=r.useState(null),[f,J]=r.useState("all"),[c,M]=r.useState(100),[W,U]=r.useState(!1),[Q,A]=r.useState(""),[I,E]=r.useState(!1),[X,$]=r.useState(null),[L,T]=r.useState(""),[q,z]=r.useState(!1),[x,Z]=r.useState("todayCount"),[g,F]=r.useState("desc"),_=s=>{x===s?F(t=>t==="asc"?"desc":"asc"):(Z(s),F("desc"))},ee=({col:s})=>x!==s?e.jsx(he,{className:"ml-1 h-3 w-3 opacity-40"}):g==="asc"?e.jsx(pe,{className:"ml-1 h-3 w-3"}):e.jsx(xe,{className:"ml-1 h-3 w-3"}),o=r.useCallback(async()=>{k(!0),D(null);try{const s=[];for(const t of Y)try{const a=await y("list_channel_users",{channel:t});s.push(...a)}catch{}G(s);try{const t=await y("read_config"),a=t==null?void 0:t.settings,l=a==null?void 0:a.quotas,i=l==null?void 0:l.defaultDaily;typeof i=="number"&&M(i)}catch{}}catch(s){D(`Failed to load usage data: ${String(s)}`)}finally{k(!1)}},[]);r.useEffect(()=>{o();const s=setInterval(o,3e4);return()=>clearInterval(s)},[o]);const R=r.useMemo(()=>(f==="all"?n:n.filter(s=>s.channel===f)).slice().sort((s,t)=>{const a=g==="asc"?1:-1;switch(x){case"channel":return a*s.channel.localeCompare(t.channel);case"userId":return a*s.userId.localeCompare(t.userId);case"displayName":return a*(s.displayName??"").localeCompare(t.displayName??"");case"todayCount":return a*(s.todayCount-t.todayCount);case"totalMessages":return a*(s.totalMessages-t.totalMessages);case"lastMessageAt":return a*(s.lastMessageAt??"").localeCompare(t.lastMessageAt??"");default:return 0}}),[n,f,x,g]),se=n.length,te=n.reduce((s,t)=>s+t.todayCount,0),ae=n.filter(s=>{const t=s.dailyQuota??c;return t<=0?t===0:s.todayCount>=t}).length,H=async()=>{const s=parseInt(Q,10);if(isNaN(s)||s<-1){u("Enter a valid number (-1 for unlimited, 0 to block)","error");return}E(!0);try{await y("set_default_quota",{dailyQuota:s}),M(s),U(!1),u("Default quota updated","success")}catch(t){u(`Failed to save: ${String(t)}`,"error")}finally{E(!1)}},B=async(s,t)=>{const a=L.trim(),l=a===""?null:parseInt(a,10);if(l!==null&&(isNaN(l)||l<-1)){u("Enter a valid number (-1=unlimited, 0=blocked, empty=default)","error");return}z(!0);try{await y("set_user_quota",{channel:s,userId:t,dailyQuota:l}),$(null),u("User quota updated","success"),await o()}catch(i){u(`Failed to save: ${String(i)}`,"error")}finally{z(!1)}},le=s=>s===null?`${c}`:s===-1?"Unlimited":s===0?"Blocked":String(s),re=s=>s??c??100;return C&&n.length===0?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{className:"h-8 w-40"}),e.jsx(v,{className:"h-4 w-56"})]})}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[1,2,3,4].map(s=>e.jsx(d,{children:e.jsxs(m,{className:"p-6 space-y-3",children:[e.jsx(v,{className:"h-3 w-20"}),e.jsx(v,{className:"h-7 w-16"})]})},s))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-2",children:["User Usage",e.jsx(me,{text:"Track per-user message counts across channels. Set daily quotas to limit usage. Data is stored locally in ~/.openclaw/usage/."})]}),e.jsx("p",{className:"text-muted-foreground",children:"Per-user message tracking and rate limits"})]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:o,"aria-label":"Refresh usage",children:[e.jsx(K,{className:`mr-2 h-4 w-4 ${C?"animate-spin":""}`})," Refresh"]})]}),S&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-destructive/20 bg-destructive/10 px-3 py-2 text-sm text-destructive",children:[e.jsx(ie,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{className:"flex-1",children:S}),e.jsxs(h,{variant:"ghost",size:"sm",onClick:o,children:[e.jsx(K,{className:"mr-2 h-3 w-3"})," Retry"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(d,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Total Users"}),e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:se}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Tracked across all channels"})]})]}),e.jsxs(d,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Messages Today"}),e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:te.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sum across all users"})]})]}),e.jsxs(d,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"At Quota"}),e.jsx(ge,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ae}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Users at or over limit"})]})]}),e.jsxs(d,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:"Default Quota"}),e.jsx(fe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(m,{children:[W?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-8 w-24 text-sm",value:Q,onChange:s=>A(s.target.value),onKeyDown:s=>s.key==="Enter"&&H(),placeholder:"-1, 0, 100...",autoFocus:!0}),e.jsx(h,{size:"sm",variant:"ghost",onClick:H,disabled:I,children:I?e.jsx(P,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(O,{className:"h-3.5 w-3.5"})})]}):e.jsx("div",{className:"text-2xl font-bold cursor-pointer hover:text-primary transition-colors",onClick:()=>{A(String(c)),U(!0)},title:"Click to edit",children:c===-1?"Unlimited":`${c}/day`}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to change"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Channel:"}),["all",...Y].map(s=>e.jsx(h,{variant:f===s?"default":"outline",size:"sm",onClick:()=>J(s),className:"capitalize",children:s},s))]}),e.jsx(d,{children:e.jsx(m,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{className:"border-b text-left",children:[{col:"channel",label:"Channel",align:""},{col:"userId",label:"User ID",align:""},{col:"displayName",label:"Display Name",align:""},{col:"todayCount",label:"Today",align:""},{col:"",label:"Quota",align:""},{col:"totalMessages",label:"Total",align:"text-right"},{col:"lastMessageAt",label:"Last Active",align:"text-right"}].map(({col:s,label:t,align:a})=>e.jsx("th",{className:`px-4 py-3 font-medium text-muted-foreground ${a} ${s?"cursor-pointer select-none hover:text-foreground transition-colors":""}`,onClick:s?()=>_(s):void 0,onKeyDown:s?l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),_(s))}:void 0,tabIndex:s?0:void 0,role:s?"columnheader":void 0,"aria-sort":s&&x===s?g==="asc"?"ascending":"descending":void 0,children:e.jsxs("span",{className:"inline-flex items-center",children:[t,s&&e.jsx(ee,{col:s})]})},t))})}),e.jsx("tbody",{children:R.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-muted-foreground",children:"No users tracked yet. Users appear here after pairing approval or agent activity."})}):R.map(s=>{const t=re(s.dailyQuota),a=t>0?s.todayCount/t*100:0,l=t===0||t>0&&s.todayCount>=t,i=!l&&t>0&&a>=80,w=`${s.channel}-${s.userId}`,ne=X===w;return e.jsxs("tr",{className:l?"bg-destructive/5":i?"bg-amber-500/5":"",children:[e.jsx("td",{className:"px-4 py-2.5",children:e.jsx(de,{variant:"outline",className:"capitalize text-xs",children:s.channel})}),e.jsx("td",{className:"px-4 py-2.5 font-mono text-xs",children:s.userId}),e.jsx("td",{className:"px-4 py-2.5 max-w-[200px] truncate",title:s.displayName??void 0,children:s.displayName??"-"}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsxs("div",{className:"flex items-center gap-2 min-w-[120px]",children:[e.jsx("div",{className:"flex-1 h-2 rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all ${l?"bg-destructive":i?"bg-amber-500":"bg-primary"}`,style:{width:`${Math.min(a,100)}%`}})}),e.jsxs("span",{className:"text-xs tabular-nums whitespace-nowrap",children:[s.todayCount,t>0?`/${t}`:""]})]})}),e.jsx("td",{className:"px-4 py-2.5",children:ne?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-7 w-20 text-xs",value:L,onChange:b=>T(b.target.value),onKeyDown:b=>b.key==="Enter"&&B(s.channel,s.userId),placeholder:"empty=default",autoFocus:!0}),e.jsx(h,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>B(s.channel,s.userId),disabled:q,children:q?e.jsx(P,{className:"h-3 w-3 animate-spin"}):e.jsx(O,{className:"h-3 w-3"})})]}):e.jsxs("span",{className:"cursor-pointer hover:text-primary transition-colors text-xs",onClick:()=>{$(w),T(s.dailyQuota===null?"":String(s.dailyQuota))},title:"Click to edit",children:[le(s.dailyQuota),s.dailyQuota===null&&e.jsx("span",{className:"text-muted-foreground ml-1",children:"(default)"})]})}),e.jsx("td",{className:"px-4 py-2.5 text-right tabular-nums",children:s.totalMessages.toLocaleString()}),e.jsx("td",{className:"px-4 py-2.5 text-right text-xs text-muted-foreground",children:s.lastMessageAt?new Date(s.lastMessageAt).toLocaleString():"-"})]},w)})})]})})})})]})}export{be as default};
