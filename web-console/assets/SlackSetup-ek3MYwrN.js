import{r as i,j as e,C as P,a as D,b as G,d as M,e as R,L as S,v as k,w as F,B as w,g,ae as y,aj as v,ai as U,m as $,a6 as C,al as W,s as q,u as N,a3 as H}from"./index-DLzrVyEL.js";import{L as T}from"./label-N6WvVUTh.js";import{S as b}from"./SecureInput-BOCeOhgm.js";import{r as V,w as X}from"./config-DtO68tKR.js";import"./eye-D6E-mqI1.js";function A(o,s,m=1500){return new Promise(r=>{if(o())return r(!0);const u=Date.now(),l=setInterval(()=>{(o()||Date.now()-u>s)&&(clearInterval(l),r(o()))},m)})}function te({onSaved:o}){const[s,m]=i.useState(""),[r,u]=i.useState(""),[l,h]=i.useState(!1),[E,a]=i.useState(null),[O,_]=i.useState(!1),[f,j]=i.useState(null),[n,c]=i.useState("idle"),[B,d]=i.useState(""),K=async()=>{if(s){c("testing"),d("");try{const t=await g.requestAsync("channels.test",{channel:"slack",credentials:{botToken:s,appToken:r||void 0}});t!=null&&t.ok?(c("pass"),d(t.team?`Connected to ${t.team}`:"Token valid")):(c("fail"),d((t==null?void 0:t.error)??"Token rejected by Slack"))}catch{s.startsWith("xoxb-")&&s.length>20?(c("pass"),d("Token format valid — start agents to verify")):(c("fail"),d("Bot token should start with xoxb-"))}}},L=async()=>{if(s){h(!0),j(null);try{a("Storing credentials...");const t={key:"SLACK_BOT_TOKEN",provider:"slack",createdAt:new Date().toISOString(),lastRotated:null};if(await y(t),await v("SLACK_BOT_TOKEN",s),await U("SLACK_BOT_TOKEN")!==s)throw new Error("Token verification failed — stored value does not match input");if(r){const p={key:"SLACK_APP_TOKEN",provider:"slack",createdAt:new Date().toISOString(),lastRotated:null};await y(p),await v("SLACK_APP_TOKEN",r)}a("Updating configuration...");const x=await V(),I={...x,settings:{...x.settings,channels:{...x.settings.channels,slack:{enabled:!0}}}};await X(I),$()==="web"?(a("Applying configuration..."),await C(),a("Starting Slack bot..."),await new Promise(p=>setTimeout(p,4e3))):(a("Syncing to agent engine..."),await W(),await C(),a("Restarting agent engine..."),await q("gateway"),a("Connecting to agent engine..."),g.reconnect(),await A(()=>N.getState().gatewayConnected,25e3)||(g.reconnect(),await A(()=>N.getState().gatewayConnected,1e4))),_(!0),H("Slack configured — bot is connecting","success"),setTimeout(()=>o==null?void 0:o(),1200)}catch(t){j(`Failed to save: ${String(t)}`)}finally{h(!1),a(null)}}};return e.jsxs(P,{children:[e.jsxs(D,{children:[e.jsx(G,{children:"Slack Configuration"}),e.jsx(M,{children:"Connect via Slack Bot OAuth"})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:"Bot Token (xoxb-...)"}),e.jsxs("ol",{className:"text-xs text-muted-foreground list-decimal list-inside space-y-1 mb-1",children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://api.slack.com/apps",target:"_blank",rel:"noopener noreferrer",className:"underline hover:text-foreground",children:"api.slack.com/apps"})," and click ",e.jsx("span",{className:"font-medium",children:"Create New App"})]}),e.jsx("li",{children:'Choose "From scratch", name your app, and pick your workspace'}),e.jsxs("li",{children:["Go to ",e.jsx("span",{className:"font-medium",children:"OAuth & Permissions"}),", add scopes: ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"chat:write"})," and ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"app_mentions:read"})]}),e.jsxs("li",{children:["Click ",e.jsx("span",{className:"font-medium",children:"Install to Workspace"}),", then copy the ",e.jsx("span",{className:"font-medium",children:"Bot User OAuth Token"})]})]}),e.jsx(b,{value:s,onChange:t=>{m(t),c("idle")},placeholder:"xoxb-your-bot-token"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:"App Token (xapp-...) — optional for Socket Mode"}),e.jsxs("ol",{className:"text-xs text-muted-foreground list-decimal list-inside space-y-1 mb-1",children:[e.jsxs("li",{children:["In the same app settings, go to ",e.jsx("span",{className:"font-medium",children:"Basic Information"})]}),e.jsxs("li",{children:["Scroll to ",e.jsx("span",{className:"font-medium",children:"App-Level Tokens"})," → Generate Token"]}),e.jsxs("li",{children:["Add the ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"connections:write"})," scope and copy the token"]})]}),e.jsx(b,{value:r,onChange:t=>{u(t),c("idle")},placeholder:"xapp-your-app-token"})]}),n!=="idle"&&e.jsxs("div",{className:`flex items-center gap-2 text-sm ${n==="pass"?"text-green-500":n==="fail"?"text-destructive":"text-muted-foreground"}`,children:[n==="testing"&&e.jsx(S,{className:"h-4 w-4 animate-spin"}),n==="pass"&&e.jsx(k,{className:"h-4 w-4"}),n==="fail"&&e.jsx(F,{className:"h-4 w-4"}),B]}),f&&e.jsx("p",{className:"text-sm text-destructive",children:f}),O?e.jsxs("div",{className:"flex items-center justify-center gap-2 rounded-md border border-green-500/20 bg-green-500/10 px-3 py-2.5 text-sm text-green-500",children:[e.jsx(k,{className:"h-4 w-4"}),"Slack configured — bot is connecting"]}):e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",className:"flex-1",onClick:K,disabled:!s||n==="testing"||l,title:s?void 0:"Enter a bot token first",children:n==="testing"?"Testing...":"Test Connection"}),e.jsx(w,{className:"flex-1",onClick:L,disabled:l||!s,title:s?void 0:"Enter a bot token first",children:l?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"mr-2 h-4 w-4 animate-spin"})," ",E??"Saving..."]}):"Save Configuration"})]})]})]})}export{te as SlackSetup};
