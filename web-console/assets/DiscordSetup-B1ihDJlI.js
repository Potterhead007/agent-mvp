import{r as i,j as e,C as R,a as B,b as G,d as _,e as L,a0 as M,L as v,v as w,w as P,B as S,g as x,ae as K,aj as U,ai as $,m as F,a6 as y,al as q,s as H,u as N,a3 as V}from"./index-DLzrVyEL.js";import{L as b}from"./label-N6WvVUTh.js";import{S as X}from"./SecureInput-BOCeOhgm.js";import{r as z,w as J}from"./config-DtO68tKR.js";import"./eye-D6E-mqI1.js";function C(r,s,m=1500){return new Promise(o=>{if(r())return o(!0);const u=Date.now(),l=setInterval(()=>{(r()||Date.now()-u>s)&&(clearInterval(l),o(r()))},m)})}function se({onSaved:r}){const[s,m]=i.useState(""),[o,u]=i.useState(""),[l,p]=i.useState(!1),[T,n]=i.useState(null),[D,k]=i.useState(!1),[f,h]=i.useState(null),[a,c]=i.useState("idle"),[I,d]=i.useState(""),E=async()=>{if(s){c("testing"),d("");try{const t=await x.requestAsync("channels.test",{channel:"discord",credentials:{botToken:s,guildId:o||void 0}});t!=null&&t.ok?(c("pass"),d(t.username?`Connected as ${t.username}`:"Token valid")):(c("fail"),d((t==null?void 0:t.error)??"Token rejected by Discord"))}catch{s.length>50&&s.includes(".")?(c("pass"),d("Token format valid — start agents to verify")):(c("fail"),d("Token format invalid — Discord bot tokens are long strings with dots"))}}},O=async()=>{if(s){p(!0),h(null);try{n("Storing credentials...");const t={key:"DISCORD_BOT_TOKEN",provider:"discord",createdAt:new Date().toISOString(),lastRotated:null};if(await K(t),await U("DISCORD_BOT_TOKEN",s),await $("DISCORD_BOT_TOKEN")!==s)throw new Error("Token verification failed — stored value does not match input");n("Updating configuration...");const g=await z(),A={...g,settings:{...g.settings,channels:{...g.settings.channels,discord:{enabled:!0,guildId:o||void 0}}}};await J(A),F()==="web"?(n("Applying configuration..."),await y(),n("Starting Discord bot..."),await new Promise(j=>setTimeout(j,4e3))):(n("Syncing to agent engine..."),await q(),await y(),n("Restarting agent engine..."),await H("gateway"),n("Connecting to agent engine..."),x.reconnect(),await C(()=>N.getState().gatewayConnected,25e3)||(x.reconnect(),await C(()=>N.getState().gatewayConnected,1e4))),k(!0),V("Discord configured — bot is connecting","success"),setTimeout(()=>r==null?void 0:r(),1200)}catch(t){h(`Failed to save: ${String(t)}`)}finally{p(!1),n(null)}}};return e.jsxs(R,{children:[e.jsxs(B,{children:[e.jsx(G,{children:"Discord Configuration"}),e.jsx(_,{children:"Connect your Discord bot"})]}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Bot Token"}),e.jsxs("ol",{className:"text-xs text-muted-foreground list-decimal list-inside space-y-1 mb-1",children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://discord.com/developers/applications",target:"_blank",rel:"noopener noreferrer",className:"underline hover:text-foreground",children:"discord.com/developers/applications"})," → ",e.jsx("span",{className:"font-medium",children:"New Application"})]}),e.jsxs("li",{children:["Go to the ",e.jsx("span",{className:"font-medium",children:"Bot"})," tab → click ",e.jsx("span",{className:"font-medium",children:"Reset Token"})," → copy the token"]}),e.jsxs("li",{children:["Scroll down to ",e.jsx("span",{className:"font-medium",children:"Privileged Gateway Intents"})," and turn on ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"Message Content Intent"})]}),e.jsxs("li",{children:["Go to ",e.jsx("span",{className:"font-medium",children:"OAuth2 → URL Generator"}),", select ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"bot"})," scope, then invite the bot to your server"]})]}),e.jsx(X,{value:s,onChange:t=>{m(t),c("idle")},placeholder:"Enter Discord bot token"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Server ID (optional)"}),e.jsxs("ol",{className:"text-xs text-muted-foreground list-decimal list-inside space-y-1 mb-1",children:[e.jsxs("li",{children:["In Discord, go to ",e.jsx("span",{className:"font-medium",children:"Settings → App Settings → Advanced"})," and enable ",e.jsx("span",{className:"font-medium",children:"Developer Mode"})]}),e.jsxs("li",{children:["Right-click your server name → ",e.jsx("span",{className:"font-medium",children:"Copy Server ID"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground/70",children:"If left blank, your bot will respond in all servers it's been invited to."}),e.jsx(M,{value:o,onChange:t=>u(t.target.value),placeholder:"Enter guild/server ID"})]}),a!=="idle"&&e.jsxs("div",{className:`flex items-center gap-2 text-sm ${a==="pass"?"text-green-500":a==="fail"?"text-destructive":"text-muted-foreground"}`,children:[a==="testing"&&e.jsx(v,{className:"h-4 w-4 animate-spin"}),a==="pass"&&e.jsx(w,{className:"h-4 w-4"}),a==="fail"&&e.jsx(P,{className:"h-4 w-4"}),I]}),f&&e.jsx("p",{className:"text-sm text-destructive",children:f}),D?e.jsxs("div",{className:"flex items-center justify-center gap-2 rounded-md border border-green-500/20 bg-green-500/10 px-3 py-2.5 text-sm text-green-500",children:[e.jsx(w,{className:"h-4 w-4"}),"Discord configured — bot is connecting"]}):e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{variant:"outline",className:"flex-1",onClick:E,disabled:!s||a==="testing"||l,title:s?void 0:"Enter a bot token first",children:a==="testing"?"Testing...":"Test Connection"}),e.jsx(S,{className:"flex-1",onClick:O,disabled:l||!s,title:s?void 0:"Enter a bot token first",children:l?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"mr-2 h-4 w-4 animate-spin"})," ",T??"Saving..."]}):"Save Configuration"})]})]})]})}export{se as DiscordSetup};
