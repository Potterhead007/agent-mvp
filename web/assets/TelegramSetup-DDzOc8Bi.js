import{r as o,j as e,C as L,a as D,b as F,d as G,e as R,L as y,v as j,w as _,B as S,g,ae as M,aj as I,ai as q,m as K,a6 as v,al as P,s as $,u as C,a3 as H}from"./index-DMLsphgf.js";import{L as U}from"./label-C04T9kgc.js";import{S as V}from"./SecureInput-g-y9d4Mj.js";import{r as X,w as Y}from"./config-CjXRnFJJ.js";import"./eye-xZN8o4kq.js";function b(r,t,f=1500){return new Promise(c=>{if(r())return c(!0);const m=Date.now(),x=setInterval(()=>{(r()||Date.now()-m>t)&&(clearInterval(x),c(r()))},f)})}function te({onSaved:r}){const[t,f]=o.useState(""),[c,m]=o.useState(!1),[x,s]=o.useState(null),[E,N]=o.useState(!1),[w,T]=o.useState(null),[n,l]=o.useState("idle"),[k,d]=o.useState(""),A=async()=>{if(t){l("testing"),d("");try{const a=await g.requestAsync("channels.test",{channel:"telegram",credentials:{botToken:t}});a!=null&&a.ok?(l("pass"),d(a.username?`Connected as @${a.username}`:"Token valid")):(l("fail"),d((a==null?void 0:a.error)??"Token rejected by Telegram"))}catch{t.includes(":")&&t.length>30?(l("pass"),d("Token format valid — start agents to verify")):(l("fail"),d("Token format invalid — expected format: 123456:ABC-DEF..."))}}},B=async()=>{if(t){m(!0),T(null);try{s("Storing credentials...");const a={key:"TELEGRAM_BOT_TOKEN",provider:"telegram",createdAt:new Date().toISOString(),lastRotated:null};if(await M(a),await I("TELEGRAM_BOT_TOKEN",t),await q("TELEGRAM_BOT_TOKEN")!==t)throw new Error("Token verification failed — stored value does not match input");s("Updating configuration...");const p=await X(),O={...p,settings:{...p.settings,channels:{...p.settings.channels,telegram:{enabled:!0}}}};await Y(O),K()==="web"?(s("Applying configuration..."),await v(),await g.requestAsync("config.apply",{}).catch(()=>{}),s("Starting Telegram bot..."),await new Promise(i=>setTimeout(i,3e3))):(s("Syncing to agent engine..."),await P(),await v(),s("Restarting agent engine..."),await $("gateway"),s("Connecting to agent engine..."),g.reconnect(),await b(()=>C.getState().gatewayConnected,25e3)||(g.reconnect(),await b(()=>C.getState().gatewayConnected,1e4))),s("Verifying Telegram connection...");try{const i=await g.requestAsync("channels.status",{probe:!0}),h=(i==null?void 0:i.channels)??i,u=h==null?void 0:h.telegram;if(u!=null&&u.lastError)throw new Error(String(u.lastError))}catch{}N(!0),H("Telegram configured — bot is connecting","success"),setTimeout(()=>r==null?void 0:r(),1200)}catch(a){T(`Failed to save: ${String(a)}`)}finally{m(!1),s(null)}}};return e.jsxs(L,{children:[e.jsxs(D,{children:[e.jsx(F,{children:"Telegram Configuration"}),e.jsx(G,{children:"Set up your Telegram bot connection"})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Bot Token"}),e.jsxs("ol",{className:"text-xs text-muted-foreground list-decimal list-inside space-y-1 mb-1",children:[e.jsxs("li",{children:["Open Telegram and search for ",e.jsx("span",{className:"font-medium",children:"@BotFather"})]}),e.jsxs("li",{children:["Send ",e.jsx("span",{className:"font-mono bg-muted px-1 rounded",children:"/newbot"})," and follow the prompts to name your bot"]}),e.jsx("li",{children:"BotFather will give you a token — copy it and paste it below"})]}),e.jsxs("p",{className:"text-xs text-muted-foreground/70",children:["Your token looks like: ",e.jsx("span",{className:"font-mono",children:"123456789:ABCDefGH..."})]}),e.jsx(V,{value:t,onChange:a=>{f(a),l("idle")},placeholder:"Enter your bot token from @BotFather"})]}),n!=="idle"&&e.jsxs("div",{className:`flex items-center gap-2 text-sm ${n==="pass"?"text-green-500":n==="fail"?"text-destructive":"text-muted-foreground"}`,children:[n==="testing"&&e.jsx(y,{className:"h-4 w-4 animate-spin"}),n==="pass"&&e.jsx(j,{className:"h-4 w-4"}),n==="fail"&&e.jsx(_,{className:"h-4 w-4"}),k]}),w&&e.jsx("p",{className:"text-sm text-destructive",children:w}),E?e.jsxs("div",{className:"flex items-center justify-center gap-2 rounded-md border border-green-500/20 bg-green-500/10 px-3 py-2.5 text-sm text-green-500",children:[e.jsx(j,{className:"h-4 w-4"}),"Telegram configured — bot is connecting"]}):e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{variant:"outline",className:"flex-1",onClick:A,disabled:!t||n==="testing"||c,title:t?void 0:"Enter a bot token first",children:n==="testing"?"Testing...":"Test Connection"}),e.jsx(S,{className:"flex-1",onClick:B,disabled:c||!t,title:t?void 0:"Enter a bot token first",children:c?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"})," ",x??"Saving..."]}):"Save Configuration"})]})]})]})}export{te as TelegramSetup};
